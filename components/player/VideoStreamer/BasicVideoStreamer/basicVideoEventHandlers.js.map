{"version":3,"sources":["../../../../src/replay/components/player/VideoStreamer/BasicVideoStreamer/basicVideoEventHandlers.js"],"names":["defaultPauseUpdateInterval","calculateBufferedAhead","videoElement","currentTime","buffered","ahead","i","length","start","end","getBasicVideoEventHandlers","streamer","streamRangeHelper","configuration","applyProperties","updateStreamState","log","isSafariOrEdge","navigator","userAgent","indexOf","lifeCycleManager","setStage","_","getStage","isPipAvailable","document","pictureInPictureEnabled","disablePictureInPicture","webkitSupportsPresentationMode","webkitSetPresentationMode","onError","playbackError","props","onPlaybackError","error","severity","playState","isBuffering","isSeeking","pauseStreamRangeUpdater","stop","onLoadStart","initialPlaybackProps","isMuted","volume","bitrateFix","bitrateCap","muted","onLoadedMetadata","isPaused","pause","calculateNewState","onCanPlay","stage","paused","bufferedAhead","onWaiting","onStalled","onPlaying","onPause","onSeeking","onSeeked","onDurationChange","onTimeUpdate","onVolumeChange","onProgress","onEnded","handleEnterPictureInPicture","isPipActive","handleLeavePictureInPicture","handlePlaybackTargetAvailabilityChanged","evt","availability","isAirPlayAvailable","handleCurrentPlaybackTargetIsWirelessChanged","isAirPlayActive","webkitCurrentPlaybackTargetIsWireless","handlePresentationModeChanged","webkitPresentationMode","onPauseInterval","adjustForDvrStartOffset","setLifeCycleManager","manager","pauseUpdateInterval","addEventListener","cleanup","removeEventListener","videoElementEventHandlers"],"mappings":"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","sourcesContent":["// @flow\nimport mapError from './errorMapper';\nimport type { InitialPlaybackProps, PlaybackProps, PlaybackSource, VideoStreamState } from '../types';\nimport type { PlaybackLifeCycle, StreamRangeHelper } from '../common/types';\nimport { PlaybackError } from '../types';\nimport { getIntervalRunner } from '../../../common';\n\nconst defaultPauseUpdateInterval = 5;\n\nfunction calculateBufferedAhead(videoElement: HTMLVideoElement): number {\n  const currentTime = videoElement.currentTime;\n  const buffered = videoElement.buffered;\n  let ahead = 0;\n\n  for (let i = 0; i < buffered.length; ++i) {\n    if (buffered.start(i) - 2 <= currentTime && buffered.end(i) + 2 >= currentTime) {\n      ahead = buffered.end(i) - currentTime;\n      break;\n    }\n  }\n  return ahead;\n}\n\nexport type BasicVideoEventHandlersProps = {\n  onPlaybackError?: PlaybackError => void,\n  initialPlaybackProps?: InitialPlaybackProps,\n  source?: ?PlaybackSource\n};\n\nconst getBasicVideoEventHandlers = <P: BasicVideoEventHandlersProps>({\n  streamer,\n  videoElement,\n  streamRangeHelper,\n  configuration,\n  applyProperties,\n  updateStreamState,\n  log\n}: {\n  streamer: {\n    props: P\n  },\n  videoElement: HTMLVideoElement,\n  streamRangeHelper: StreamRangeHelper,\n  configuration: ?{ pauseUpdateInterval?: ?number },\n  applyProperties: PlaybackProps => void,\n  updateStreamState: VideoStreamState => void,\n  log?: string => void\n}) => {\n  const isSafariOrEdge =\n    navigator.userAgent.indexOf('Edge') > 0 ||\n    (navigator.userAgent.indexOf('Safari') > 0 &&\n      navigator.userAgent.indexOf('Chrome') < 0 &&\n      navigator.userAgent.indexOf('Firefox') < 0);\n\n  let lifeCycleManager = {\n    setStage: (_: PlaybackLifeCycle) => {},\n    getStage: () => {}\n  };\n\n  function isPipAvailable() {\n    return (\n      // $FlowFixMe: Too exotic for React's HTML element typedefs.\n      (document.pictureInPictureEnabled && !videoElement.disablePictureInPicture) || // $FlowFixMe\n      (videoElement.webkitSupportsPresentationMode &&\n      videoElement.webkitSupportsPresentationMode('picture-in-picture') && // $FlowFixMe\n        typeof videoElement.webkitSetPresentationMode === 'function') ||\n      false\n    );\n  }\n\n  function onError() {\n    const playbackError = mapError(videoElement);\n    if (streamer.props.onPlaybackError) {\n      streamer.props.onPlaybackError(playbackError);\n    }\n    updateStreamState({ error: videoElement.error });\n    if (playbackError.severity === 'FATAL') {\n      lifeCycleManager.setStage('dead');\n      updateStreamState({ playState: 'inactive', isBuffering: false, isSeeking: false });\n    }\n    pauseStreamRangeUpdater.stop();\n  }\n\n  function onLoadStart() {\n    log && log('loadstart');\n    if (lifeCycleManager.getStage() === 'new') {\n      lifeCycleManager.setStage('starting');\n      if (streamer.props.initialPlaybackProps) {\n        const { isMuted, volume, bitrateFix, bitrateCap } = streamer.props.initialPlaybackProps;\n        applyProperties({ isMuted, volume, bitrateFix: bitrateFix, bitrateCap: bitrateCap });\n      }\n      updateStreamState({\n        playState: 'starting',\n        isBuffering: true,\n        volume: videoElement.volume,\n        isMuted: videoElement.muted\n      });\n    }\n  }\n\n  function onLoadedMetadata() {\n    log && log('loadedmetadata');\n    if (streamer.props.initialPlaybackProps && streamer.props.initialPlaybackProps.isPaused) {\n      videoElement.pause();\n    }\n    updateStreamState(streamRangeHelper.calculateNewState());\n    updateStreamState({\n      isPipAvailable: isPipAvailable()\n    });\n  }\n\n  function onCanPlay() {\n    log && log('canplay');\n    // If starting as paused, we consider \"canplay\" as completed starting. The playState must be updated accordingly.\n    // When starting as playing, the starting to started transition is handled by the onPlaying handler.\n    const stage = lifeCycleManager.getStage();\n    if (stage === 'starting') {\n      if (streamer.props.initialPlaybackProps && streamer.props.initialPlaybackProps.isPaused) {\n        lifeCycleManager.setStage('started');\n      }\n    } else if (stage === 'started') {\n      updateStreamState({ isBuffering: false, playState: videoElement.paused ? 'paused' : 'playing' });\n    }\n    updateStreamState({\n      bufferedAhead: calculateBufferedAhead(videoElement),\n      isPipAvailable: isPipAvailable()\n    });\n\n    if (videoElement.paused) {\n      updateStreamState({ playState: 'paused', isPaused: true, isBuffering: false, isSeeking: false });\n      pauseStreamRangeUpdater.start();\n    }\n  }\n\n  function onWaiting() {\n    log && log('waiting');\n    updateStreamState({ isBuffering: true });\n    if (lifeCycleManager.getStage() === 'started') {\n      updateStreamState({ playState: 'buffering' });\n    }\n  }\n\n  function onStalled() {\n    log && log('stalled');\n    // The stalled event is fired also after pausing in Safari.\n    if (!isSafariOrEdge) {\n      updateStreamState({ isBuffering: true });\n      if (lifeCycleManager.getStage() === 'started') {\n        updateStreamState({ playState: 'buffering' });\n      }\n    }\n  }\n\n  function onPlaying() {\n    log && log('playing');\n    // When this is invoked, and we are not starting as paused, we consider the playback as started.\n    if (lifeCycleManager.getStage() === 'starting') {\n      lifeCycleManager.setStage('started');\n    }\n    if (lifeCycleManager.getStage() === 'started') {\n      updateStreamState({ playState: 'playing', isBuffering: false, isPaused: false, isSeeking: false });\n    }\n    pauseStreamRangeUpdater.stop();\n  }\n\n  function onPause() {\n    log && log('pause');\n    if (lifeCycleManager.getStage() === 'started') {\n      updateStreamState({ playState: 'paused', isPaused: true });\n    }\n    pauseStreamRangeUpdater.start();\n  }\n\n  function onSeeking() {\n    log && log('seeking');\n    pauseStreamRangeUpdater.stop();\n    if (lifeCycleManager.getStage() === 'started') {\n      updateStreamState({ playState: 'seeking', isSeeking: true });\n    }\n  }\n\n  function onSeeked() {\n    log && log('seeked');\n    if (isSafariOrEdge) {\n      if (videoElement.paused) {\n        updateStreamState({ playState: 'paused', isPaused: true, isBuffering: false, isSeeking: false });\n        pauseStreamRangeUpdater.start();\n      } else {\n        updateStreamState({ playState: 'playing', isPaused: false, isBuffering: false, isSeeking: false });\n        pauseStreamRangeUpdater.stop();\n      }\n    }\n  }\n\n  function onDurationChange() {\n    log && log('durationchange');\n    updateStreamState(streamRangeHelper.calculateNewState());\n  }\n\n  function onTimeUpdate() {\n    updateStreamState(streamRangeHelper.calculateNewState());\n  }\n\n  function onVolumeChange() {\n    log && log('volumechange');\n    updateStreamState({ volume: videoElement.volume, isMuted: videoElement.muted });\n  }\n\n  function onProgress() {\n    updateStreamState({ bufferedAhead: calculateBufferedAhead(videoElement) });\n  }\n\n  function onEnded() {\n    log && log('ended');\n    if (lifeCycleManager.getStage() === 'started') {\n      //lifeCycleManager.setStage('ended');\n      updateStreamState({ playState: 'inactive' });\n    }\n    pauseStreamRangeUpdater.stop();\n  }\n\n  function handleEnterPictureInPicture() {\n    updateStreamState({ isPipActive: true });\n  }\n\n  function handleLeavePictureInPicture() {\n    updateStreamState({ isPipActive: false });\n  }\n\n  // START Ugly Safari custom events and properties section\n\n  function handlePlaybackTargetAvailabilityChanged(evt: { availability: 'available' | 'not-available' }) {\n    if (evt.availability === 'available') {\n      updateStreamState({ isAirPlayAvailable: true });\n    } else {\n      updateStreamState({ isAirPlayAvailable: false });\n    }\n  }\n\n  function handleCurrentPlaybackTargetIsWirelessChanged(evt) {\n    // We don't know the current state, and need to guess based on a toggle.\n    // $FlowFixMe: Typedefs not up-to-date.\n    updateStreamState({ isAirPlayActive: videoElement.webkitCurrentPlaybackTargetIsWireless });\n  }\n\n  function handlePresentationModeChanged() {\n    // $FlowFixMe: Too exotic for Safari typedefs.\n    if (videoElement.webkitPresentationMode === 'picture-in-picture') {\n      updateStreamState({ isPipActive: true });\n    } else {\n      updateStreamState({ isPipActive: false });\n    }\n  }\n\n  // END Ugly Safari custom events and properties section\n\n  function onPauseInterval() {\n    streamRangeHelper.adjustForDvrStartOffset();\n    updateStreamState(streamRangeHelper.calculateNewState());\n  }\n\n  function setLifeCycleManager(manager: { setStage: PlaybackLifeCycle => void, getStage: () => PlaybackLifeCycle }) {\n    lifeCycleManager = manager;\n  }\n\n  const pauseStreamRangeUpdater = getIntervalRunner(\n    onPauseInterval,\n    (configuration && configuration.pauseUpdateInterval) || defaultPauseUpdateInterval\n  );\n\n  videoElement.addEventListener('enterpictureinpicture', handleEnterPictureInPicture);\n  videoElement.addEventListener('leavepictureinpicture', handleLeavePictureInPicture);\n  videoElement.addEventListener(\n    'webkitcurrentplaybacktargetiswirelesschanged',\n    handleCurrentPlaybackTargetIsWirelessChanged\n  );\n  // $FlowFixMe: evt.availability is unknown to React.\n  videoElement.addEventListener('webkitplaybacktargetavailabilitychanged', handlePlaybackTargetAvailabilityChanged);\n  videoElement.addEventListener('webkitpresentationmodechanged', handlePresentationModeChanged);\n\n  function cleanup() {\n    videoElement.removeEventListener('enterpictureinpicture', handleEnterPictureInPicture);\n    videoElement.removeEventListener('leavepictureinpicture', handleLeavePictureInPicture);\n    videoElement.removeEventListener(\n      'webkitcurrentplaybacktargetiswirelesschanged',\n      handleCurrentPlaybackTargetIsWirelessChanged\n    );\n    // $FlowFixMe: evt.availability is unknown to React.\n    videoElement.removeEventListener(\n      'webkitplaybacktargetavailabilitychanged',\n      handlePlaybackTargetAvailabilityChanged\n    );\n    videoElement.removeEventListener('webkitpresentationmodechanged', handlePresentationModeChanged);\n  }\n\n  return {\n    videoElementEventHandlers: {\n      onLoadStart,\n      onLoadedMetadata,\n      onCanPlay,\n      onWaiting,\n      onStalled,\n      onPlaying,\n      onPause,\n      onSeeking,\n      onSeeked,\n      onDurationChange,\n      onTimeUpdate,\n      onVolumeChange,\n      onProgress,\n      onError,\n      onEnded\n    },\n    pauseStreamRangeUpdater,\n    setLifeCycleManager,\n    isPipAvailable,\n    cleanup\n  };\n};\n\nexport default getBasicVideoEventHandlers;\n"],"file":"basicVideoEventHandlers.js"}