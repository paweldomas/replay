{"version":3,"sources":["../../../../src/replay/components/player/VideoStreamer/HlsjsVideoStreamer/hlsjsEventHandlers.js"],"names":["getHlsjsEventHandlers","streamer","videoElement","instanceKeeper","streamRangeHelper","configuration","applyProperties","updateStreamState","log","htmlVideoHandlers","videoElementEventHandlers","pauseStreamRangeUpdater","lifeCycleManager","setStage","_","getStage","lastMediaErrorTime","handleActualError","detail","playbackError","hls","autoRecoverStreamErrors","hlsjs","severity","props","onPlaybackError","error","type","Hls","ErrorTypes","NETWORK_ERROR","startLoad","MEDIA_ERROR","Date","now","undefined","swapAudioCodec","recoverMediaError","playState","isBuffering","isSeeking","stop","setLifeCycleManager","manager","hlsjsEventHandlers","Events","ERROR","evt","data","details","ErrorDetails","BUFFER_STALLED_ERROR","BUFFER_SEEK_OVER_HOLE","BUFFER_NUDGE_ON_STALL","MANIFEST_PARSING_ERROR","url","endsWith","MANIFEST_LOADING","initialPlaybackProps","isMuted","volume","muted","isPipAvailable","FRAG_BUFFERED","MANIFEST_PARSED","isPaused","bitrateFix","bitrateCap","pause","calculateNewState","onHlsInstance","hlsInstance","preposition","Object","entries","forEach","name","handler","subscribers","push","onCanPlay","onPlaying","onPause","onSeeking","onSeeked","onDurationChange","onTimeUpdate","onVolumeChange","onProgress","onEnded"],"mappings":"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","sourcesContent":["// @flow\nimport type { PlaybackLifeCycle, StreamRangeHelper } from '../common/types';\nimport getBasicVideoEventHandlers from '../BasicVideoStreamer/basicVideoEventHandlers';\nimport Hls, { type HlsjsErrorData } from 'hls.js';\nimport type { PlaybackProps, VideoStreamState } from '../types';\nimport type { BasicVideoEventHandlersProps } from '../BasicVideoStreamer/basicVideoEventHandlers';\nimport { mapHlsjsError } from './hlsjsErrorMapper';\nimport type { HlsjsInstanceKeeper } from './HlsjsVideoStreamer';\n\ndeclare class Object {\n  static entries<TKey, TValue>({ [key: TKey]: TValue }): [TKey, TValue][];\n}\n\nconst getHlsjsEventHandlers = <P: BasicVideoEventHandlersProps>({\n  streamer,\n  videoElement,\n  instanceKeeper,\n  streamRangeHelper,\n  configuration,\n  applyProperties,\n  updateStreamState,\n  log\n}: {\n  streamer: {\n    props: P\n  },\n  videoElement: HTMLVideoElement,\n  instanceKeeper: HlsjsInstanceKeeper,\n  streamRangeHelper: StreamRangeHelper,\n  configuration: ?{\n    pauseUpdateInterval?: ?number,\n    hlsjs: {\n      customConfiguration?: any,\n      autoRecoverStreamErrors?: boolean\n    }\n  },\n  applyProperties: PlaybackProps => void,\n  updateStreamState: VideoStreamState => void,\n  log?: string => void\n}) => {\n  const htmlVideoHandlers = getBasicVideoEventHandlers({\n    streamer,\n    videoElement,\n    streamRangeHelper,\n    configuration,\n    log,\n    applyProperties,\n    updateStreamState\n  });\n\n  const { videoElementEventHandlers, pauseStreamRangeUpdater } = htmlVideoHandlers;\n\n  let lifeCycleManager = {\n    setStage: (_: PlaybackLifeCycle) => {},\n    getStage: () => {}\n  };\n\n  let lastMediaErrorTime;\n\n  function handleActualError(detail) {\n    log && log('hlsjs.error');\n    const playbackError = mapHlsjsError(lifeCycleManager.getStage() === 'started', detail);\n    const hls = instanceKeeper.hls;\n    const autoRecoverStreamErrors = configuration && configuration.hlsjs && configuration.hlsjs.autoRecoverStreamErrors;\n    if (hls && playbackError.severity === 'FATAL') {\n      if (streamer.props.onPlaybackError) {\n        streamer.props.onPlaybackError(playbackError);\n      }\n      if (videoElement.error) {\n        updateStreamState({ error: videoElement.error });\n      }\n      if (autoRecoverStreamErrors && detail.type === Hls.ErrorTypes.NETWORK_ERROR) {\n        hls.startLoad();\n      } else if (autoRecoverStreamErrors && detail.type === Hls.ErrorTypes.MEDIA_ERROR) {\n        if (lastMediaErrorTime && Date.now() - 1000 < lastMediaErrorTime) {\n          lastMediaErrorTime = undefined;\n          hls.swapAudioCodec();\n        } else {\n          lastMediaErrorTime = Date.now();\n        }\n        hls.recoverMediaError();\n      } else {\n        lifeCycleManager.setStage('dead');\n        updateStreamState({ playState: 'inactive', isBuffering: false, isSeeking: false });\n      }\n    }\n    pauseStreamRangeUpdater.stop();\n  }\n\n  function setLifeCycleManager(manager: { setStage: PlaybackLifeCycle => void, getStage: () => PlaybackLifeCycle }) {\n    lifeCycleManager = manager;\n    htmlVideoHandlers.setLifeCycleManager(manager);\n  }\n\n  const hlsjsEventHandlers = {\n    [Hls.Events.ERROR]: (evt: any, data: HlsjsErrorData) => {\n      switch (data.details) {\n        case Hls.ErrorDetails.BUFFER_STALLED_ERROR:\n          updateStreamState({ isBuffering: true });\n          if (lifeCycleManager.getStage() === 'started') {\n            updateStreamState({ playState: 'buffering' });\n          }\n          break;\n        case Hls.ErrorDetails.BUFFER_SEEK_OVER_HOLE:\n        case Hls.ErrorDetails.BUFFER_NUDGE_ON_STALL:\n          break;\n        case Hls.ErrorDetails.MANIFEST_PARSING_ERROR:\n          if (data.url && !data.url.endsWith('undefined')) {\n            handleActualError(data);\n          }\n          break;\n        default:\n          handleActualError(data);\n      }\n    },\n    [Hls.Events.MANIFEST_LOADING]: () => {\n      log && log('hlsjs.loading');\n      lastMediaErrorTime = undefined;\n      if (lifeCycleManager.getStage() === 'new') {\n        lifeCycleManager.setStage('starting');\n        if (streamer.props.initialPlaybackProps) {\n          const { isMuted, volume } = streamer.props.initialPlaybackProps;\n          applyProperties({ isMuted, volume });\n        }\n        updateStreamState({\n          playState: 'starting',\n          isBuffering: true,\n          volume: videoElement.volume,\n          isMuted: videoElement.muted,\n          isPipAvailable: htmlVideoHandlers.isPipAvailable()\n        });\n      }\n    },\n    [Hls.Events.FRAG_BUFFERED]: () => {\n      updateStreamState({ isBuffering: false });\n    },\n    [Hls.Events.MANIFEST_PARSED]: () => {\n      log && log('hlsjs.parsed');\n      if (streamer.props.initialPlaybackProps) {\n        const { isPaused, bitrateFix, bitrateCap } = streamer.props.initialPlaybackProps;\n        if (isPaused) {\n          videoElement.pause();\n        }\n        applyProperties({ bitrateFix, bitrateCap });\n        if (bitrateFix == null) {\n          updateStreamState({ bitrateFix: null });\n        }\n        if (bitrateCap == null) {\n          updateStreamState({ bitrateCap: null });\n        }\n      } else {\n        updateStreamState({ bitrateFix: null, bitrateCap: null });\n      }\n      updateStreamState(streamRangeHelper.calculateNewState());\n    }\n  };\n\n  function onHlsInstance(hlsInstance, preposition) {\n    Object.entries(hlsjsEventHandlers).forEach(([name, handler]) => {\n      // $FlowFixMe\n      hlsInstance[preposition](name, handler);\n    });\n  }\n\n  instanceKeeper.subscribers.push(onHlsInstance);\n\n  const {\n    onCanPlay,\n    onPlaying,\n    onPause,\n    onSeeking,\n    onSeeked,\n    onDurationChange,\n    onTimeUpdate,\n    onVolumeChange,\n    onProgress,\n    onEnded\n  } = videoElementEventHandlers;\n  return {\n    videoElementEventHandlers: {\n      onCanPlay,\n      onPlaying,\n      onPause,\n      onSeeking,\n      onSeeked,\n      onDurationChange,\n      onTimeUpdate,\n      onVolumeChange,\n      onProgress,\n      onEnded\n    },\n    pauseStreamRangeUpdater,\n    setLifeCycleManager\n  };\n};\n\nexport default getHlsjsEventHandlers;\n"],"file":"hlsjsEventHandlers.js"}